<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurador de Fotos Antiguas</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@300;400&display=swap');

  :root {
    --sepia: #c8a97e;
    --dark: #1a1209;
    --cream: #f5efe3;
    --warm: #8b5e3c;
    --accent: #d4a853;
    --paper: #ede5d4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: var(--cream);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  header {
    padding: 3rem 2rem 1.5rem;
    text-align: center;
    border-bottom: 1px solid rgba(200,169,126,0.2);
    position: relative;
  }

  header::after {
    content: '‚ú¶ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú¶ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú¶';
    display: block;
    color: var(--sepia);
    font-size: 0.7rem;
    letter-spacing: 0.5em;
    margin-top: 1.2rem;
    opacity: 0.6;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .subtitle {
    font-size: 0.75rem;
    color: var(--sepia);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-top: 0.5rem;
  }

  main {
    max-width: 960px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  @media (max-width: 650px) {
    main { grid-template-columns: 1fr; }
  }

  .panel {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(200,169,126,0.15);
    border-radius: 2px;
    padding: 1.8rem;
    position: relative;
  }

  .panel-label {
    font-size: 0.65rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: var(--sepia);
    margin-bottom: 1rem;
  }

  /* Upload zone */
  #drop-zone {
    border: 2px dashed rgba(200,169,126,0.3);
    border-radius: 2px;
    min-height: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: border-color 0.3s, background 0.3s;
    position: relative;
    overflow: hidden;
  }

  #drop-zone:hover, #drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(212,168,83,0.05);
  }

  #drop-zone .upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    filter: sepia(1);
  }

  #drop-zone p {
    font-size: 0.75rem;
    color: var(--sepia);
    text-align: center;
    line-height: 1.8;
  }

  #drop-zone p strong {
    color: var(--accent);
  }

  #file-input { display: none; }

  #preview-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    position: absolute;
    inset: 0;
    padding: 8px;
    filter: sepia(0.3) contrast(0.9);
  }

  /* Options */
  .options-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }

  .option-item {
    display: flex;
    align-items: flex-start;
    gap: 0.7rem;
    padding: 0.8rem;
    border: 1px solid rgba(200,169,126,0.1);
    border-radius: 2px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }

  .option-item:hover {
    background: rgba(212,168,83,0.05);
    border-color: rgba(200,169,126,0.3);
  }

  .option-item input[type=checkbox] {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
    margin-top: 2px;
    flex-shrink: 0;
  }

  .option-item label {
    cursor: pointer;
  }

  .option-title {
    font-size: 0.75rem;
    color: var(--cream);
    display: block;
    margin-bottom: 0.2rem;
  }

  .option-desc {
    font-size: 0.65rem;
    color: var(--sepia);
    line-height: 1.5;
  }

  .btn-restore {
    width: 100%;
    padding: 0.9rem;
    background: var(--accent);
    color: var(--dark);
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  .btn-restore:hover:not(:disabled) { background: #e8bc5f; transform: translateY(-1px); }
  .btn-restore:active:not(:disabled) { transform: translateY(0); }
  .btn-restore:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Result panel */
  #result-panel {
    grid-column: 1 / -1;
    display: none;
  }

  #result-panel.visible { display: block; }

  .result-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 580px) { .result-grid { grid-template-columns: 1fr; } }

  .result-img-wrap {
    border: 1px solid rgba(200,169,126,0.15);
    padding: 8px;
    background: rgba(0,0,0,0.3);
    text-align: center;
  }

  .result-img-wrap img {
    width: 100%;
    max-height: 320px;
    object-fit: contain;
  }

  .img-label {
    font-size: 0.6rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--sepia);
    margin-top: 0.6rem;
  }

  .analysis-box {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(200,169,126,0.15);
    border-left: 3px solid var(--accent);
    padding: 1.2rem;
    font-size: 0.72rem;
    line-height: 1.9;
    color: #d4c8b4;
    white-space: pre-wrap;
    border-radius: 0 2px 2px 0;
  }

  .analysis-box h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: var(--accent);
    margin-bottom: 0.8rem;
  }

  /* Download */
  .btn-download {
    display: inline-block;
    padding: 0.7rem 1.5rem;
    border: 1px solid var(--sepia);
    color: var(--sepia);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    text-decoration: none;
    cursor: pointer;
    background: transparent;
    transition: all 0.2s;
    margin-top: 1rem;
  }

  .btn-download:hover { border-color: var(--accent); color: var(--accent); }

  /* Loading */
  .loading-wrap {
    display: none;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    color: var(--sepia);
    font-size: 0.72rem;
  }

  .loading-wrap.visible { display: flex; }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid rgba(200,169,126,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-log {
    font-size: 0.65rem;
    color: var(--sepia);
    margin-top: 0.5rem;
    min-height: 1rem;
    letter-spacing: 0.05em;
    opacity: 0.8;
  }

  .error-msg {
    color: #c87e7e;
    font-size: 0.72rem;
    padding: 1rem;
    border: 1px solid rgba(200,100,100,0.2);
    background: rgba(200,100,100,0.05);
    margin-top: 1rem;
    display: none;
  }

  .error-msg.visible { display: block; }

  /* Decorative corners */
  .panel::before, .panel::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-color: var(--sepia);
    border-style: solid;
    opacity: 0.3;
  }

  .panel::before { top: 6px; left: 6px; border-width: 1px 0 0 1px; }
  .panel::after { bottom: 6px; right: 6px; border-width: 0 1px 1px 0; }
</style>
</head>
<body>

<header>
  <h1>Restaurador de Memorias</h1>
  <p class="subtitle">Inteligencia artificial ¬∑ Restauraci√≥n fotogr√°fica</p>
</header>

<main>
  <!-- Upload panel -->
  <div class="panel">
    <div class="panel-label">‚ë† Sube tu fotograf√≠a</div>
    <div id="drop-zone" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon">üì∑</div>
      <p>
        <strong>Haz clic o arrastra</strong> una foto aqu√≠<br>
        JPG, PNG, WEBP ¬∑ M√°x. 5 MB<br>
        <span style="opacity:0.5;font-size:0.65rem">Fotos antiguas, da√±adas, descoloridas‚Ä¶</span>
      </p>
      <img id="preview-img" style="display:none"/>
    </div>
    <input type="file" id="file-input" accept="image/*">
  </div>

  <!-- Options panel -->
  <div class="panel">
    <div class="panel-label">‚ë° Opciones de restauraci√≥n</div>
    <div class="options-grid">
      <div class="option-item">
        <input type="checkbox" id="opt-scratch" checked>
        <label for="opt-scratch">
          <span class="option-title">Eliminar ara√±azos y manchas</span>
          <span class="option-desc">Detecta y describe c√≥mo reparar rayas, polvo y deterioro f√≠sico</span>
        </label>
      </div>
      <div class="option-item">
        <input type="checkbox" id="opt-contrast" checked>
        <label for="opt-contrast">
          <span class="option-title">Mejorar contraste y luminosidad</span>
          <span class="option-desc">Recupera el rango tonal original perdido por el tiempo</span>
        </label>
      </div>
      <div class="option-item">
        <input type="checkbox" id="opt-color" checked>
        <label for="opt-color">
          <span class="option-title">Restauraci√≥n de color / colorizaci√≥n</span>
          <span class="option-desc">Analiza el balance de color o sugiere colores para fotos B&N</span>
        </label>
      </div>
      <div class="option-item">
        <input type="checkbox" id="opt-faces" checked>
        <label for="opt-faces">
          <span class="option-title">Mejorar detalles faciales</span>
          <span class="option-desc">Identificar y reconstruir rasgos faciales borrosos o da√±ados</span>
        </label>
      </div>
      <div class="option-item">
        <input type="checkbox" id="opt-context">
        <label for="opt-context">
          <span class="option-title">An√°lisis hist√≥rico y contextual</span>
          <span class="option-desc">Estima la √©poca, lugar, y contexto hist√≥rico de la fotograf√≠a</span>
        </label>
      </div>
    </div>

    <button class="btn-restore" id="btn-restore" disabled onclick="restorePhoto()">
      Restaurar fotograf√≠a
    </button>

    <div class="loading-wrap" id="loading">
      <div class="spinner"></div>
      <div>
        <div>Analizando imagen con IA‚Ä¶</div>
        <div class="progress-log" id="progress-log"></div>
      </div>
    </div>

    <div class="error-msg" id="error-msg"></div>
  </div>

  <!-- Result panel -->
  <div class="panel" id="result-panel">
    <div class="panel-label">‚ë¢ Resultado del an√°lisis</div>
    <div class="result-grid">
      <div class="result-img-wrap">
        <img id="original-display" src="" alt="Original"/>
        <div class="img-label">Original</div>
      </div>
      <div class="result-img-wrap" id="restored-wrap" style="display:none">
        <img id="restored-display" src="" alt="Restaurada"/>
        <div class="img-label">Vista restaurada (simulada)</div>
      </div>
    </div>
    <div class="analysis-box" id="analysis-box"></div>
    <br>
    <button class="btn-download" onclick="downloadReport()">‚¨á Descargar informe de restauraci√≥n</button>
  </div>
</main>

<script>
let originalImageData = null;
let currentAnalysis = '';

// Drag & drop
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

fileInput.addEventListener('change', e => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
});

function handleFile(file) {
  if (!file.type.startsWith('image/')) {
    showError('Por favor sube un archivo de imagen v√°lido.');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showError('La imagen debe ser menor a 5 MB.');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    originalImageData = e.target.result;
    const img = document.getElementById('preview-img');
    img.src = originalImageData;
    img.style.display = 'block';
    dropZone.querySelector('.upload-icon').style.display = 'none';
    dropZone.querySelector('p').style.display = 'none';
    document.getElementById('btn-restore').disabled = false;
    hideError();
    document.getElementById('result-panel').classList.remove('visible');
  };
  reader.readAsDataURL(file);
}

async function restorePhoto() {
  if (!originalImageData) return;

  const opts = {
    scratch: document.getElementById('opt-scratch').checked,
    contrast: document.getElementById('opt-contrast').checked,
    color: document.getElementById('opt-color').checked,
    faces: document.getElementById('opt-faces').checked,
    context: document.getElementById('opt-context').checked,
  };

  const selectedOpts = Object.entries(opts).filter(([,v]) => v).map(([k]) => k);
  if (!selectedOpts.length) { showError('Selecciona al menos una opci√≥n.'); return; }

  document.getElementById('btn-restore').disabled = true;
  document.getElementById('loading').classList.add('visible');
  hideError();
  document.getElementById('result-panel').classList.remove('visible');

  const logs = [
    'Procesando imagen‚Ä¶',
    'Detectando da√±os y deterioro‚Ä¶',
    'Analizando composici√≥n‚Ä¶',
    'Generando informe de restauraci√≥n‚Ä¶'
  ];
  let li = 0;
  const logEl = document.getElementById('progress-log');
  logEl.textContent = logs[li];
  const logInterval = setInterval(() => {
    li = (li + 1) % logs.length;
    logEl.textContent = logs[li];
  }, 1800);

  try {
    const base64 = originalImageData.split(',')[1];
    const mimeType = originalImageData.split(':')[1].split(';')[0];

    const taskList = [];
    if (opts.scratch) taskList.push('- Identificar y describir todos los ara√±azos, manchas, roturas, polvo o da√±os f√≠sicos visibles. Dar instrucciones espec√≠ficas de c√≥mo repararlos en software de edici√≥n.');
    if (opts.contrast) taskList.push('- Evaluar el contraste y luminosidad: ¬øest√° subexpuesta, sobreexpuesta, plana? Describir los ajustes exactos de niveles, curvas y exposici√≥n necesarios.');
    if (opts.color) taskList.push('- Si es a color: evaluar el color cast (dominantes de color), decoloraci√≥n, y pasos para corregirlo. Si es blanco y negro: sugerir una paleta de colores realista para una posible colorizaci√≥n (ropa, piel, fondo, objetos).');
    if (opts.faces) taskList.push('- Identificar caras y evaluar su estado: ¬øest√°n borrosas, da√±adas, sobreexpuestas? Describir t√©cnicas para mejorar detalles faciales.');
    if (opts.context) taskList.push('- Analizar el contexto hist√≥rico: estimar la d√©cada, regi√≥n geogr√°fica probable, ocasi√≥n o evento fotografiado, vestimenta, tecnolog√≠a visible. A√±adir datos culturales interesantes.');

    const systemPrompt = `Eres un experto en restauraci√≥n fotogr√°fica con d√©cadas de experiencia en fotograf√≠a hist√≥rica y t√©cnicas de edici√≥n digital. Recibir√°s una fotograf√≠a antigua o da√±ada y deber√°s proporcionar un an√°lisis profesional detallado.

Responde siempre en espa√±ol. S√© espec√≠fico y t√©cnico pero accesible. Usa emojis sutiles para organizar secciones. Incluye una puntuaci√≥n de da√±o del 0-100% al inicio.

Estructura tu respuesta con secciones claras usando encabezados en may√∫sculas seguidos de dos puntos.`;

    const userPrompt = `Analiza esta fotograf√≠a y proporciona un informe completo de restauraci√≥n.

TAREAS A REALIZAR:
${taskList.join('\n')}

AL FINAL incluye:
- RESUMEN EJECUTIVO: Un p√°rrafo con el estado general y potencial de restauraci√≥n.
- PASOS RECOMENDADOS: Lista numerada de acciones en orden de prioridad para restaurar la imagen.
- SOFTWARE SUGERIDO: Herramientas espec√≠ficas (Photoshop, Lightroom, GIMP, etc.) y sus funciones relevantes.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: mimeType, data: base64 }
            },
            { type: 'text', text: userPrompt }
          ]
        }]
      })
    });

    clearInterval(logInterval);

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'Error de API');
    }

    const data = await response.json();
    currentAnalysis = data.content[0]?.text || 'Sin respuesta.';

    // Show result
    document.getElementById('original-display').src = originalImageData;
    document.getElementById('analysis-box').innerHTML = '<h3>üìã Informe de Restauraci√≥n</h3>' + formatAnalysis(currentAnalysis);
    document.getElementById('result-panel').classList.add('visible');
    document.getElementById('result-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });

  } catch (err) {
    clearInterval(logInterval);
    showError('Error al procesar: ' + err.message);
  } finally {
    document.getElementById('loading').classList.remove('visible');
    document.getElementById('btn-restore').disabled = false;
  }
}

function formatAnalysis(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--accent)">$1</strong>')
    .replace(/^#{1,3}\s+(.+)$/gm, '<strong style="color:var(--accent);font-size:0.85rem">$1</strong>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}

function downloadReport() {
  if (!currentAnalysis) return;
  const blob = new Blob([`INFORME DE RESTAURACI√ìN FOTOGR√ÅFICA\nGenerado por Restaurador de Memorias\n${'='.repeat(50)}\n\n${currentAnalysis}`], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'informe-restauracion.txt';
  a.click();
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.classList.add('visible');
}

function hideError() {
  document.getElementById('error-msg').classList.remove('visible');
}
</script>
</body>
</html>
